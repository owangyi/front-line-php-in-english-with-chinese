# 第二十二章

## 异步 PHP

在讨论 MVC 模式时，我们研究了为什么它非常适合 PHP，特别是因为 PHP 有一个非常干净的请求/响应周期。每次新请求到达时，新进程启动并从零开始启动我们的 PHP 应用程序。这个特性

```php
使 PHP 如此容易上手：你不需要任何编译器，你不需要处理跨请求的共享状态或担心内存管理；

```

它超级简单。

不过，简单并不总是首选。PHP 中有一个社区，这些年来开始越来越受欢迎：异步社区。在这本书中值得提及它们，因为最近有越来越多的异步 PHP 用例。现代 PHP 不仅用于为博客或小型公司网站提供动力；它还用于大规模构建大型 Web 应用程序，在某些情况下，异步会带来显著价值。

提前说明：我无法在本章中深入解释异步编程。解释异步需要一本书。本章的目标是让你了解 PHP 的选项。所以我假设你知道一些异步相关的词汇。如果不是这样，也不用担心，它仍然会是一个有趣的阅读，但如果你对这个话题感兴趣，你可能需要做一些后续研究。在这种情况下，我建议你看看 JavaScript 社区，它像没有其他语言一样拥抱异步编程，并有很好的资源来学习异步思维。

## 什么是异步？

通过"异步 PHP"，我们指的是一个 PHP 进程可以同时处理几件事。

你可以使用线程或创建子进程，每个都专用于单个任务。反过来，父进程将监视和管理所有这些子进程。例如，你可以为每个传入的请求创建一个子进程，并从父进程共享已加载和启动的框架，而不是在每个请求上从零开始启动它。

不过，异步不仅仅是管理子进程。想想处理 I/O，比如读取文件或与外部服务通信。不是执行数据库查询并等待结果再执行下一个，你可以并行执行所有查询。假设你有十个查询，每个需要一秒钟执行；你可以在一个秒内运行所有它们，而不是十秒。

简而言之，如果使用正确，异步编程可以显著提高性能。

不过，大多数 MVC 框架没有针对异步思维进行优化：它们假设每次新请求到达时都必须从零开始启动。反过来，它们尝试通过缓存和将配置编译为优化的生产就绪版本来优化该过程的各个部分。你可能本能地认为，如果你能够跳过框架的"启动阶段"，你会看到巨大的性能改进；不过，情况并非完全如此。

你看，拥有"共享应用程序状态"并在 PHP 中并行处理请求不会有显著差异：你的 Web 服务器已经在运行多个进程来并行服务请求。除此之外，你可以使用预加载来让应用程序在内存中启动并准备好。最大的性能提升来自异步处理 I/O，大多数框架没有针对此进行优化。它们不是用异步思维构建的。这很好，因为异步 PHP 增加了一层复杂性，对许多项目来说都是过度的。

考虑到这一点，你不应该期望通过简单地组合 MVC 框架和像 Amp 或 ReactPHP 这样的异步框架来获得突破性的性能提升——还有更多。异步有比普通 MVC 应用程序更有趣的用例。

想想需要做大量实时重型计算的复杂 API。当我询问社区中谁有异步 PHP 的实际用例时，

有人告诉我他们使用 Swoole 运行他们的 API。Swoole 使他们能够在进程之间静态缓存数据以减少数据库 I/O，并并行进行复杂计算。总的来说，他们能够每秒服务 8000 个请求，而不是 600 个。

## 异步框架

我刚才提到了 Swoole，还谈到了 Amp（全称 Amphp）和 ReactPHP。这些是今天使用的三个最流行的异步框架。Amp 和 ReactPHP 是用 PHP 本身实现的。你可以在项目中使用 composer 下载它们，你就准备好了。另一方面，Swoole 是一个 PHP 扩展，你必须在系统上安装它。虽然 ReactPHP 将自己描述为"事件驱动、非阻塞 I/O 的 PHP 框架"；Swoole 是一个"基于协程的异步 PHP 编程框架"。

除了完整的异步框架，还有流行的 Guzzle HTTP 库，它可以并行执行 HTTP 请求。这是异步编程的一种更简单和隔离的方法，但也有几个用例。假设你正在从分页 API 加载数据；你可以一次加载几页，而不是一页一页地加载。

每个框架都有自己的目标受众和需求；所有都是今天在生产中使用的流行选择。我遇到的另一个实际例子是一个定期使用 AWS Lambda 发送 100,000 个推送通知的平台。不是生成 100,000 个 Lambda，他们将数据分块为 500 个组，并将每个组并行发送到总共 200 个 Lambda。他们使用 Guzzle 并行执行 200 个 HTTP 请求，并等待它们全部完成。反过来，每个 Lambda 也会并行发送 500 个推送通知，并在不到一分钟内完成。总的来说，由于异步编程，发送 100,000 个推送通知需要 2 分钟。

人们有时将 PHP 与 NodeJS 进行比较，并提到它缺乏异步功能，

但事实恰恰相反。PHP 中有很多异步编程的选项。它们今天在生产中用于各种用例。PHP 与 JavaScript 的不同之处在于它没有内置的异步编程支持，如 async、await 或 promises。有人有兴趣在 PHP 核心中添加 libuv，这是为 Node 的异步功能提供动力的同一库。还没有任何尝试集成它，但 PHP 有一天可能会有一个内置的异步引擎。

在那之前，已经有很好的、经过实战测试的解决方案可以在今天使用。

