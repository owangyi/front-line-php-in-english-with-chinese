# 第二十章

## 内部机制

在这本书中，我们重点关注了几个与语法相关的核心功能。这些功能来自哪里？谁决定什么被添加到语言中，什么不被添加？我之前提到过"内部"组一两次——是他们在做决定吗？

确实有一群核心开发人员编写和维护所有使 PHP 运行的代码。此外，还有扩展开发人员、文档维护者、发布经理和其他 PHP 项目角色。所有这些人一起组成了决定什么被添加到 PHP 中，什么不被添加的组。他们是拥有投票权的人。

这些投票权在每次 RFC 结束时使用——"request for comments"（征求意见）。

RFC 是一份描述新功能或语言更改的文档；它会被讨论一段时间（最少两周），最后进行投票。如果 RFC 有 2/3 的多数票赞成，它被认为被接受，功能被添加到语言中。

## PHP RFC：属性 v2

作为一个例子，这里是属性 RFC 的（缩短版本）。你会注意到此 RFC 中使用的旧属性语法，它只是后来才被更改。Version: 0.5 Date: 2020-03-09 Author: Benjamin Eberlei ( beberlei@php.net ), Martin Schröder Status: Implemented Target: 8.0 First Published at: http://wiki.php.net/rfc/attributes_v2 Implementation: https://github.com/php/php-src/pull/5394 此 RFC 的大部分功劳归功于 Dmitry Stogov，他之前关于属性的工作是此 RFC 和补丁的基础。

## 介绍

此 RFC 提议将属性作为结构化、语法元数据的形式，用于类、属性、函数、方法、参数和常量的声明。属性允许直接嵌入代码声明的配置指令。

类似的概念存在于其他语言中，在 Java 中称为注解，在 C#、C++、Rust、Hack 中称为属性，在 Python、Javascript 中称为装饰器。

到目前为止，PHP 只提供这种元数据的非结构化形式：文档注释。

但文档注释只是字符串，为了保持一些结构化信息，各种 PHP 子社区在它们内部发明了基于 @ 的伪语言。

除了用户空间用例之外，引擎和扩展中还有许多属性的用例，可能影响编译、诊断、代码生成、运行时行为等。下面给出了示例。

用户空间文档注释解析的广泛使用表明，这是社区高度要求的功能。

## 提案

### 属性语法

属性是一种特殊格式的文本，通过重用现有标记 T_SL 和 T_SR，用 "<<" 和 ">>" 括起来。

属性可以应用于语言中的许多东西：

函数（包括闭包和短闭包）类（包括匿名类）、接口、trait 类常量类属性类方法函数/方法参数示例：

<<ExampleAttribute>>

```php
class Foo

{

```

    <<ExampleAttribute>>

```php
    public const FOO = 'foo';

 

```

    <<ExampleAttribute>>

```php
    public $x;

 

```

    <<ExampleAttribute>>

```php
    public function foo(<<ExampleAttribute>> $bar) { }

}

```

…

理论上，每个人都允许制作 RFC。你不需要拥有投票权。

每个用户空间开发人员——你和我——都可以提交一个想法供讨论。不过，有一个重要的注意事项：如果你设法让 RFC 被接受，它仍然需要一个实现。事实上，在 RFC 投票之前有一个工作实现通常是一个优势。所以虽然从技术上讲，你可以在 RFC 被接受后要求某人实现你的功能，但能够自己编码或与能够事先实现更改的人密切合作是一个资产。

用几段描述了 RFC 过程，它可能看起来非常简单直接。当然，大多数时候，合理的 RFC 会被批准。但也有例外，RFC 可能变得非常有争议，导致冗长的讨论。最近的一个例子是属性 RFC，我之前展示的摘录。最初被接受的 RFC 已经是第七次尝试在 PHP 中添加类似注解的行为。那些之前的尝试发生在几年中，最早可以追溯到 2010 年 8 月！

有几个原因导致属性花了十年时间才被添加。首先，有关于属性应该和不应该做什么的讨论：它们支持的功能越多，实现就越复杂。有关于属性应该看起来像什么，应该使用什么语法的讨论。这些问题延长了讨论期，并在此过程中导致一些失败的 RFC。不过，多年来，这个想法可以进一步完善，可能必须做出一些妥协。

其中一个妥协是属性的语法，在属性被接受后，又花了两个额外的 RFC 来决定。有像这样的选项：@, @@, =<=> , =[],

还有更多。最后，=[] 被选为最佳选项，因为 @ 不可用，因为它已经是错误抑制运算符。需要数月的讨论才能最终达成一致的语法。已经提出了许多好的论据，支持和反对所有选项。

所有这些讨论都是公开进行的。你可以通过加入内部邮件列表来很好地关注。有一个名为 externals.io 的网站，它在网页上公开邮件，使它们更容易阅读。我认为关注这个列表是件好事，了解一点 PHP 是如何设计的过程。即使你从未打算为 PHP 的核心做出贡献，了解你正在使用的工具如何发展以及用户空间开发人员如何在该过程中提供有价值的反馈仍然是件好事。

我们也看到越来越多的核心贡献者在过去几年中倾听用户空间开发人员。有些人坚持认为核心开发人员不关心实际 PHP 的偏见，但这绝对不再是事实。核心开发人员和用户空间开发人员之间在社交媒体、GitHub 和内部列表上有很多互动。

PHP 开发中的几个关键人物接触用户空间开发人员，以更好地了解实际 PHP 项目中需要什么。

还有改进的空间，但 PHP 在过去十年中已经成熟。这也体现在内部过程中。

